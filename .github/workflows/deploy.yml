name: Deploy Statistics Service

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

env:
  AWS_REGION: us-east-1
  DYNAMODB_TABLE_NAME: UrlShortenerTable
  LAMBDA_FUNCTION_NAME: statistic-service

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: Import Existing Resources
        working-directory: ./terraform
        continue-on-error: true
        run: |
          # Get AWS account ID
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          
          # Import IAM Role if it exists
          terraform import -var="aws_region=${{ env.AWS_REGION }}" \
            -var="table_name=${{ env.DYNAMODB_TABLE_NAME }}" \
            -var="lambda_function_name=${{ env.LAMBDA_FUNCTION_NAME }}" \
            aws_iam_role.lambda_role ${{ env.LAMBDA_FUNCTION_NAME }}-role || true
          
          # Import IAM Policy if it exists
          terraform import -var="aws_region=${{ env.AWS_REGION }}" \
            -var="table_name=${{ env.DYNAMODB_TABLE_NAME }}" \
            -var="lambda_function_name=${{ env.LAMBDA_FUNCTION_NAME }}" \
            aws_iam_policy.dynamodb_policy arn:aws:iam::${ACCOUNT_ID}:policy/${{ env.LAMBDA_FUNCTION_NAME }}-dynamodb-policy || true
          
          # Import Lambda CloudWatch Log Group if it exists
          terraform import -var="aws_region=${{ env.AWS_REGION }}" \
            -var="table_name=${{ env.DYNAMODB_TABLE_NAME }}" \
            -var="lambda_function_name=${{ env.LAMBDA_FUNCTION_NAME }}" \
            aws_cloudwatch_log_group.lambda_logs /aws/lambda/${{ env.LAMBDA_FUNCTION_NAME }} || true
          
          # Import API Gateway CloudWatch Log Group if it exists
          terraform import -var="aws_region=${{ env.AWS_REGION }}" \
            -var="table_name=${{ env.DYNAMODB_TABLE_NAME }}" \
            -var="lambda_function_name=${{ env.LAMBDA_FUNCTION_NAME }}" \
            aws_cloudwatch_log_group.api_logs /aws/apigateway/${{ env.LAMBDA_FUNCTION_NAME }} || true
          
          echo "Import step completed (errors ignored if resources already in state)"

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var="aws_region=${{ env.AWS_REGION }}" \
            -var="table_name=${{ env.DYNAMODB_TABLE_NAME }}" \
            -var="lambda_function_name=${{ env.LAMBDA_FUNCTION_NAME }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: ./terraform
        run: terraform apply -auto-approve tfplan

      - name: Get API Gateway URL
        working-directory: ./terraform
        run: |
          echo "API Gateway URL:"
          terraform output -raw api_gateway_url
          echo "API_URL=$(terraform output -raw api_gateway_url)" >> $GITHUB_ENV

      - name: Deployment Summary
        run: |
          echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** Statistics Service" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Lambda Function:** ${{ env.LAMBDA_FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**API Endpoint:** ${{ env.API_URL }}" >> $GITHUB_STEP_SUMMARY
